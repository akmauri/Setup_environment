# Story 1.2: Multi-Tenant Database Architecture

**Status:** Draft  
**Epic:** Epic 1 - Foundation & Core Infrastructure  
**Story Number:** 1.2  
**Created:** 2026-01-XX  
**Last Updated:** 2026-01-XX

---

## Story Statement

**As a** system architect  
**I want** a schema-per-tenant database architecture  
**So that** tenant data is completely isolated and the system can scale to thousands of tenants

---

## Acceptance Criteria

1. PostgreSQL 15+ database configured with connection pooling (PgBouncer)
2. Database migration system implemented (TypeORM, Prisma, or similar) with version control
3. Public schema created for system-wide tables (tenants, migrations, shared_data like countries, timezones)
4. Tenant schema creation function implemented that creates isolated schema per tenant on signup
5. All tenant-specific tables created in tenant schemas (users, content, workflows, social_accounts, analytics, etc.)
6. Database connection middleware automatically routes queries to correct tenant schema based on JWT token
7. Tenant schema deletion function implemented for complete data removal (GDPR compliance)
8. Database backup strategy configured with daily snapshots and point-in-time recovery capability
9. Read replica support configured for horizontal scaling of read operations
10. Migration rollback capability tested and documented

---

## Dev Notes

### Architecture Context

**Source:** `docs/ARCHITECTURE.md`

#### Database Stack

- **Database:** PostgreSQL 15+ [Source: ARCHITECTURE.md#Tech-Stack]
- **Connection Pooling:** PgBouncer (recommended) [Source: PRD Story 1.2]
- **ORM/Migration Tool:** TypeORM or Prisma [Source: PRD Story 1.2, ARCHITECTURE.md#Tenant-Service]
- **Architecture Pattern:** Schema-per-tenant [Source: ARCHITECTURE.md#Database-Schema]

#### Schema Architecture

**Public Schema (System-Wide):**

- `tenants` - Tenant metadata and settings [Source: ARCHITECTURE.md#Database-Schema]
- `migrations` - Database migration history [Source: ARCHITECTURE.md#Database-Schema]
- `shared_data` - Countries, timezones, platform metadata [Source: ARCHITECTURE.md#Database-Schema]

**Tenant Schema (Per Tenant):**
Each tenant has isolated schema with tables:

- `users` - User accounts [Source: ARCHITECTURE.md#Database-Schema]
- `content` - Media content [Source: ARCHITECTURE.md#Database-Schema]
- `social_accounts` - Connected platform accounts [Source: ARCHITECTURE.md#Database-Schema]
- `workflows` - Workflow definitions [Source: ARCHITECTURE.md#Database-Schema]
- `publish_jobs` - Publishing jobs [Source: ARCHITECTURE.md#Database-Schema]
- `analytics` - Performance metrics [Source: ARCHITECTURE.md#Database-Schema]
- `teams` - Team management [Source: ARCHITECTURE.md#Database-Schema]
- `comments` - Content comments [Source: ARCHITECTURE.md#Database-Schema]
- `notifications` - In-app notifications [Source: ARCHITECTURE.md#Database-Schema]

#### Service Architecture

- **Tenant Service:** Manages schema creation/deletion, tenant context resolution [Source: ARCHITECTURE.md#Tenant-Service]
- **Technology Stack:** Node.js/Express, PostgreSQL (schema management), TypeORM/Prisma migrations [Source: ARCHITECTURE.md#Tenant-Service]

#### Database Schema Details

**Tenants Table (Public Schema):**

```sql
CREATE TABLE public.tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  subdomain VARCHAR(100) UNIQUE,
  tier VARCHAR(50) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'active',
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Users Table (Tenant Schema):**

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id),
  email VARCHAR(255) NOT NULL,
  password_hash VARCHAR(255),
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL,
  avatar_url TEXT,
  email_verified BOOLEAN DEFAULT false,
  two_factor_enabled BOOLEAN DEFAULT false,
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, email)
);
```

[Source: ARCHITECTURE.md#Database-Schema]

#### File Locations (Project Structure)

- **Database Package:** `packages/db/`
- **Migrations:** `packages/db/migrations/`
- **Database Client:** `packages/db/src/index.ts`
- **Models/Entities:** `packages/db/src/models/` or `packages/db/src/entities/`
- **Tenant Service:** `apps/api/src/services/tenant.service.ts`
- **Connection Middleware:** `apps/api/src/middleware/db.middleware.ts`
- **Database Config:** `packages/db/src/config/database.config.ts`

#### API Endpoints (Tenant Service)

- `POST /api/tenants` - Create new tenant (creates schema)
- `GET /api/tenants/:id` - Get tenant info
- `DELETE /api/tenants/:id` - Delete tenant (removes schema)
- `GET /api/tenants/:id/schema` - Get schema info

---

## Tasks / Subtasks

### Task 1: Configure PostgreSQL with Connection Pooling (AC: 1)

- [ ] Verify PostgreSQL 15+ is running (Docker Compose)
- [ ] Install PgBouncer or configure connection pooling
- [ ] Set up connection pool configuration:
  - Pool size: 20-50 connections
  - Max connections per tenant: 5-10
  - Connection timeout: 30 seconds
- [ ] Configure connection string with pooling
- [ ] Test connection pooling works correctly

### Task 2: Set Up Database Migration System (AC: 2)

- [ ] Choose migration tool: TypeORM or Prisma
  - **Recommendation**: Prisma (better TypeScript support, easier schema management)
- [ ] Install chosen tool:
  - Prisma: `npm install prisma @prisma/client`
  - TypeORM: `npm install typeorm pg`
- [ ] Initialize migration system in `packages/db/`
- [ ] Create migration directory structure
- [ ] Set up migration commands in `package.json`:
  - `db:migrate` - Run migrations
  - `db:migrate:create` - Create new migration
  - `db:migrate:rollback` - Rollback last migration
  - `db:migrate:status` - Check migration status
- [ ] Configure migration tracking table

### Task 3: Create Public Schema Tables (AC: 3)

- [ ] Create migration: `0001_create_public_schema.sql`
- [ ] Create `public.tenants` table:
  - id (UUID, primary key)
  - name (VARCHAR)
  - subdomain (VARCHAR, unique)
  - tier (VARCHAR)
  - status (VARCHAR)
  - settings (JSONB)
  - timestamps
- [ ] Create `public.migrations` table (if not auto-managed by tool)
- [ ] Create `public.shared_data` table or structure:
  - countries (reference data)
  - timezones (reference data)
  - platform_metadata (reference data)
- [ ] Seed initial shared data (countries, timezones)
- [ ] Run migration and verify tables created

### Task 4: Implement Tenant Schema Creation Function (AC: 4)

- [ ] Create `apps/api/src/services/tenant.service.ts`:
  - `createTenant(name, subdomain, tier): Promise<Tenant>`
  - `createTenantSchema(tenantId: string): Promise<void>`
- [ ] Implement schema creation SQL:
  ```sql
  CREATE SCHEMA IF NOT EXISTS tenant_{tenant_id};
  ```
- [ ] Set up proper permissions for tenant schema
- [ ] Create tenant record in `public.tenants` table
- [ ] Test schema creation works
- [ ] Add error handling and rollback on failure

### Task 5: Create Tenant Schema Tables (AC: 5)

- [ ] Create migration: `0002_create_tenant_schema_tables.sql`
- [ ] Design tenant schema tables:
  - `users` table (from architecture)
  - `content` table (from architecture)
  - `social_accounts` table
  - `workflows` table
  - `publish_jobs` table
  - `analytics` table
  - `teams` table
  - `comments` table
  - `notifications` table
- [ ] Create indexes for performance:
  - Foreign key indexes
  - Query optimization indexes
- [ ] Create migration function that applies to tenant schema
- [ ] Test table creation in test tenant schema

### Task 6: Implement Database Connection Middleware (AC: 6)

- [ ] Create `apps/api/src/middleware/db.middleware.ts`:
  - Extract tenant_id from JWT token
  - Set PostgreSQL search_path to tenant schema
  - `SET search_path TO tenant_{tenant_id}, public;`
- [ ] Create connection pool per tenant (or use search_path)
- [ ] Implement tenant context resolution:
  - From JWT token (preferred)
  - From subdomain (fallback)
  - From header (alternative)
- [ ] Add middleware to Express app
- [ ] Test queries route to correct schema
- [ ] Add error handling for invalid tenant

### Task 7: Implement Tenant Schema Deletion (AC: 7)

- [ ] Create `deleteTenantSchema(tenantId: string): Promise<void>`:
  - Drop tenant schema: `DROP SCHEMA IF EXISTS tenant_{tenant_id} CASCADE;`
  - Soft delete tenant record (or hard delete)
  - Log deletion for audit
- [ ] Implement GDPR compliance:
  - Verify all data is removed
  - Log deletion timestamp
  - Optional: 30-day retention before hard delete
- [ ] Add confirmation/authorization check
- [ ] Test schema deletion works
- [ ] Verify no orphaned data remains

### Task 8: Configure Database Backup Strategy (AC: 8)

- [ ] Set up automated backup script or service
- [ ] Configure daily snapshots:
  - Full database backup
  - Include all tenant schemas
  - Store in S3 or backup location
- [ ] Configure point-in-time recovery:
  - Enable WAL (Write-Ahead Logging)
  - Configure WAL archiving
  - Test recovery process
- [ ] Document backup and recovery procedures
- [ ] Set up backup monitoring/alerting

### Task 9: Configure Read Replica Support (AC: 9)

- [ ] Design read replica architecture:
  - Primary: Write operations
  - Replica: Read operations
- [ ] Configure connection routing:
  - Write queries → Primary
  - Read queries → Replica (with fallback to primary)
- [ ] Implement replica connection pool
- [ ] Add health checks for replicas
- [ ] Test read/write separation works
- [ ] Document replica configuration

### Task 10: Test Migration Rollback (AC: 10)

- [ ] Create test migration
- [ ] Run migration forward
- [ ] Test rollback functionality
- [ ] Verify data integrity after rollback
- [ ] Document rollback procedures
- [ ] Create rollback checklist

---

## Project Structure Notes

- Database package: `packages/db/` (shared across monorepo)
- Migrations: `packages/db/migrations/` (version-controlled)
- Tenant service: `apps/api/src/services/tenant.service.ts`
- Database middleware: `apps/api/src/middleware/db.middleware.ts`
- Connection config: Environment variables (DATABASE_URL, etc.)

---

## Dependencies

- **Depends on**: Story 1.1 (Project Setup) - Must be complete or mostly complete
- **Required for**: Story 1.3 (User Authentication) - Cannot proceed without database

---

## Technical Decisions

- **Migration Tool**: Choose between TypeORM and Prisma
  - **Prisma Recommended**: Better TypeScript support, easier schema management, excellent migration system
- **Connection Strategy**: Use PostgreSQL `search_path` for tenant routing (simpler than connection pools per tenant)
- **Schema Naming**: `tenant_{uuid}` format for tenant schemas
- **Backup Strategy**: Daily snapshots + WAL archiving for point-in-time recovery

---

## Dev Agent Record

_To be filled by Dev Agent during implementation_

### Implementation Notes

_Dev Agent will document implementation details here_

### Completion Notes

_Dev Agent will document completion status here_

### Debug Log References

_Dev Agent will reference debug logs here_

---

## QA Agent Record

_To be filled by QA Agent during review_

### Test Results

_QA Agent will document test results here_

### Issues Found

_QA Agent will document any issues found here_

### Approval Status

_QA Agent will mark approval status here_

---

## Story Status History

| Date       | Status | Changed By | Notes                                   |
| ---------- | ------ | ---------- | --------------------------------------- |
| 2026-01-XX | Draft  | SM Agent   | Story created and ready for development |
